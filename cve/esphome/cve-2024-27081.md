# Remote code execution via arbitrary file write (CVE-2024-27081) #

## Summary
A security misconfiguration in the "edit configuration file" API of the "dashboard" component of ESPHome allows authenticated remote attackers to read and write arbitrary files under the configuration directory, allowing possible remote code execution. The vulnerability has been discovered on version 2023.12.9 (command line installation).

## Affected products
* ESPHome version 2023.12.9

## Details
It is possible to abuse a path traversal vulnerability in both command line installation and Home Assistant add-on, which allows an attacker to read and write files under the configuration directory.

The vulnerability is present and appears exploitable in the command line installation, where it is possible to access sensitive files like esphome.json and board firmware source code. On the other hand, in the home assistant add-on version, while the vulnerability can still be exploited, the gained filesystem access is limited to less sensitive yaml configuration files (that are also accessible via web interface).

## PoC
As a proof of concept consider these arbitrary file read examples:

<img src="https://github.com/esphome/esphome/assets/115887876/d2da3180-976e-4bed-b4b9-35ac960a7fb4" width="500" />

**esphome.json configuration file read**

<img src="https://github.com/esphome/esphome/assets/115887876/707fb6d7-d4a8-461e-bbb7-05382471e925" width="500" />

**Firmware source code read**

Now consider these images that show respectively how to inject arbitrary python code and proof of the actual execution:

<img src="https://github.com/esphome/esphome/assets/115887876/c6cb28d8-352d-4fea-b77a-705f63be94e3" width="500" />

**Arbitrary python code injection**

<img src="https://github.com/esphome/esphome/assets/115887876/5eb0f14c-ceb2-4b15-8898-c02c610763d1" width="500" />

**Arbitrary python code execution**


## Impact
The issue gives read and write access to files stored in the configuration directory, and allows malicious users to actually write arbitrary code in python scripts executed during firmware compiling and flashing of ESP boards.

If chained with CVE-2024-29019 and CVE-2024-27287, this issue could allow an unauthenticated remote user to gain remote code execution on the machine hosting the dashboard.

It also allows accessing sensitive information, such as esphome.json contents and board firmware source code, ultimately allowing a user to modify the board firmware, and leaking secrets such as: WiFi network credentials, fallback hotspot WiFi credentials, OTA component authentication password and API encryption key.

## Additional information

### Credit
Spike Reply Cybersecurity Team

### Acknowledgments
Thanks to ESPHome developers for their support with the disclosure of this issue.

### References
- https://nvd.nist.gov/vuln/detail/CVE-2024-27081
- https://github.com/esphome/esphome/security/advisories/GHSA-8p25-3q46-8q2p

### Disclosure timeline

- February 20, 2024: Initial vendor contact
- February 22, 2024 Patch proposed by ESPHome
- February 22, 2024 Spike Reply Cybersecurity Team confirms that security fixes included in patched version are effective
- February 25, 2024: Disclosure
